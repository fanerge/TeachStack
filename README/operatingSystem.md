# 存储器分级

## 存储器分级策略

我们需要综合考虑速度快（离 CPU 较近）、体积小、空间大、能耗低、散热好等因素来设计存储器分级策略。
离 CPU 较近就会导致散热不好，离 CPU 较远就会导致速度慢。
一种可行的方案，就是根据数据的使用频率使用不同的存储器：高频使用的数据，读写越快越好，因此用最贵的材料，放到离 CPU 最近的位置；使用频率越低的数据，我们放到离 CPU 越远的位置，用越便宜的材料。

### 分级策略

寄存器；
L1-Cache；
L2-Cache；
L3-Cahce；
内存；
硬盘/SSD

### 寄存器（Register）

寄存器紧挨着 CPU 的控制单元和逻辑计算单元，它所使用的材料速度也是最快的。
寄存器的数量通常在几十到几百之间，每个寄存器可以用来存储一定字节（byte）的数据。
寄存机的访问速度非常快，一般要求在半个 CPU 时钟周期内完成读写。<br>
作用：寄存器的主要作用是用来暂时存放参与运算的数据和运算结果，具有接收数据、存放数据和输出数据的功能。

### L1-Cache

L1- 缓存在 CPU 中，相比寄存器，虽然它的位置距离 CPU 核心更远，但造价更低。通常 L1-Cache 大小在几十 Kb 到几百 Kb 不等，读写速度在 2~4 个 CPU 时钟周期。
协助 CPU 处理指令预读。
L1- 缓存通常会分成两个区域，一个是指令区，一个是数据区（就不会存在数据缓存覆盖了指令缓存）。

### L2-Cache

L2- 缓存也在 CPU 中，位置比 L1- 缓存距离 CPU 核心更远。它的大小比 L1-Cache 更大，具体大小要看 CPU 型号，有 2M 的，也有更小或者更大的，速度在 10~20 个 CPU 周期。

### L3-Cache

L3- 缓存同样在 CPU 中，位置比 L2- 缓存距离 CPU 核心更远。大小通常比 L2-Cache 更大，读写速度在 20~60 个 CPU 周期。L3 缓存大小也是看型号的，比如 i9 CPU 有 512KB L1 Cache；有 2MB L2 Cache； 有 16MB L3 Cache。

### 内存

内存的主要材料是半导体硅，是插在主板上工作的。因为它的位置距离 CPU 有一段距离，所以需要用总线和 CPU 连接。
内存速度大概在 200~300 个 CPU 周期之间。

### SSD 和硬盘

SSD 也叫固态硬盘，结构和内存类似，但是它的优点在于断电后数据还在。内存、寄存器、缓存断电后数据就消失了。内存的读写速度比 SSD 大概快 10~1000 倍。

## 缓存条目结构

无论是缓存，还是内存，它们都是一个线性存储器，也就是数据一个挨着一个的存储。如果我们把内存想象成一个只有 1 列的表格，那么缓存就是一个多列的表格，这个表格中的每一行叫作一个缓存条目。

### 设计缓存条目结构

比如有 1000 个内存地址，但只有 10 个缓存条目。内存地址的编号是 0、1、2、3，...，999，缓存条目的编号是 0~9。我们思考一个内存编号，比如 701，然后用数学方法把它映射到一个缓存条目，比如 701 整除 10，得到缓存条目 1（地址 % 10，其实就构成了一个简单的哈希函数）。

## 指令的预读

CPU 顺序执行内存中的指令，CPU 执行指令的速度是非常快的，一般是 2~6 个 CPU 时钟周期；我们发现内存的读写速度其实是非常慢的，大概有 200~300 个时钟周期。
解决办法就是 CPU 把内存中的指令预读几十条或者上百条到读写速度较快的 L1- 缓存中，因为 L1- 缓存的读写速度只有 2~4 个时钟周期，是可以跟上 CPU 的执行速度的。

## 缓存的命中率

命中就是指在缓存中找到需要的数据。和命中相反的是穿透，也叫 miss，就是一次读取操作没有从缓存中找到对应的数据。

## 缓存置换问题

现在 L1- 缓存条目已经存满了，接下来 CPU 又读了内存，需要把一个新的条目存到 L1- 缓存中，既然有一个新的条目要进来，那就有一个旧的条目要出去。
